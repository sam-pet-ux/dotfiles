#!/bin/bash
# =============================================================================
# yadm bootstrap - New machine setup
# =============================================================================
# This script runs automatically after `yadm clone --bootstrap` or can be
# run manually with `yadm bootstrap`.
#
# It handles:
#   - Machine role detection (primary vs secondary)
#   - Push protection for secondary machines
#   - Homebrew and essential tool installation
#   - Secret decryption
#   - Alternate symlink creation
# =============================================================================

set -e

echo "=== yadm bootstrap ==="
echo ""

# -----------------------------------------------------------------------------
# DETECT MACHINE
# -----------------------------------------------------------------------------

OS=$(uname -s)
HOSTNAME=$(hostname -s)

echo "Machine: $HOSTNAME ($OS)"
echo ""

# -----------------------------------------------------------------------------
# SET MACHINE CLASS
# -----------------------------------------------------------------------------

PRIMARY_HOSTNAME="Alex-MBP"

if [[ "$HOSTNAME" == "$PRIMARY_HOSTNAME" ]]; then
    yadm config local.class primary
    echo "[OK] Set as PRIMARY machine (can push changes)"
else
    yadm config local.class secondary
    echo "[OK] Set as SECONDARY machine (pull-only)"

    # Disable push for secondary machines
    yadm remote set-url --push origin no_push
    echo "[OK] Push disabled (remote set to 'no_push')"
fi

echo ""

# -----------------------------------------------------------------------------
# INSTALL HOMEBREW (macOS only)
# -----------------------------------------------------------------------------

if [[ "$OS" == "Darwin" ]]; then
    if ! command -v brew &>/dev/null; then
        echo "Installing Homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

        # Add Homebrew to PATH for this session
        if [[ -d /opt/homebrew ]]; then
            eval "$(/opt/homebrew/bin/brew shellenv)"
        fi
        echo "[OK] Homebrew installed"
    else
        echo "[OK] Homebrew already installed"
    fi
    echo ""
fi

# -----------------------------------------------------------------------------
# INSTALL ESSENTIAL TOOLS
# -----------------------------------------------------------------------------

if command -v brew &>/dev/null; then
    echo "Installing essential tools..."

    # List of essential tools
    TOOLS=(zoxide fzf fd ripgrep neovim)

    for tool in "${TOOLS[@]}"; do
        if ! command -v "$tool" &>/dev/null; then
            echo "  Installing $tool..."
            brew install "$tool" 2>/dev/null || true
        else
            echo "  [OK] $tool already installed"
        fi
    done
    echo ""
fi

# -----------------------------------------------------------------------------
# DECRYPT SECRETS (if archive exists)
# -----------------------------------------------------------------------------

ARCHIVE="$HOME/.local/share/yadm/archive"
if [[ -f "$ARCHIVE" ]]; then
    echo "Encrypted archive found. Run 'yadm decrypt' to decrypt secrets."
    echo "(Skipping automatic decryption - requires password)"
    echo ""
fi

# -----------------------------------------------------------------------------
# CREATE ALTERNATE SYMLINKS
# -----------------------------------------------------------------------------

echo "Creating alternate symlinks..."
yadm alt
echo "[OK] Alternates created"
echo ""

# -----------------------------------------------------------------------------
# SETUP AUTO-SYNC (primary machine only)
# -----------------------------------------------------------------------------

if [[ "$HOSTNAME" == "$PRIMARY_HOSTNAME" ]] && [[ "$OS" == "Darwin" ]]; then
    echo "Setting up auto-sync..."

    PLIST_NAME="com.yadm.autosync.plist"
    PLIST_PATH="$HOME/Library/LaunchAgents/$PLIST_NAME"
    SYNC_SCRIPT="$HOME/.local/bin/yadm-auto-sync.sh"

    # Create launchd plist if it doesn't exist
    if [[ ! -f "$PLIST_PATH" ]] && [[ -f "$SYNC_SCRIPT" ]]; then
        mkdir -p "$HOME/Library/LaunchAgents"
        cat > "$PLIST_PATH" << 'PLIST'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.yadm.autosync</string>
    <key>ProgramArguments</key>
    <array>
        <string>/bin/bash</string>
        <string>-l</string>
        <string>-c</string>
        <string>$HOME/.local/bin/yadm-auto-sync.sh</string>
    </array>
    <key>StartInterval</key>
    <integer>3600</integer>
    <key>RunAtLoad</key>
    <true/>
    <key>Nice</key>
    <integer>10</integer>
    <key>StandardOutPath</key>
    <string>/tmp/yadm-auto-sync.stdout.log</string>
    <key>StandardErrorPath</key>
    <string>/tmp/yadm-auto-sync.stderr.log</string>
    <key>EnvironmentVariables</key>
    <dict>
        <key>PATH</key>
        <string>/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin</string>
    </dict>
</dict>
</plist>
PLIST
        # Replace $HOME with actual path
        sed -i '' "s|\$HOME|$HOME|g" "$PLIST_PATH"
        echo "  [OK] Created launchd plist"
    fi

    # Load the agent if not already running
    if ! launchctl list | grep -q "com.yadm.autosync"; then
        launchctl load "$PLIST_PATH" 2>/dev/null || true
        echo "  [OK] Loaded auto-sync agent (runs hourly)"
    else
        echo "  [OK] Auto-sync agent already running"
    fi
    echo ""
fi

# -----------------------------------------------------------------------------
# SUMMARY
# -----------------------------------------------------------------------------

echo "=== Bootstrap Complete ==="
echo ""
echo "Next steps:"
echo "  1. Open a new terminal or run: source ~/.zshrc"
echo "  2. Check status: yadm status"

MACHINE_CLASS=$(yadm config local.class)
if [[ "$MACHINE_CLASS" == "primary" ]]; then
    echo ""
    echo "This is the PRIMARY machine:"
    echo "  - Auto-sync runs hourly (launchd agent)"
    echo "  - Changes are automatically committed and pushed"
    echo "  - Check sync log: cat ~/.local/share/yadm/auto-sync.log"
elif [[ "$MACHINE_CLASS" == "secondary" ]]; then
    echo ""
    echo "This is a SECONDARY machine:"
    echo "  - Push is disabled (changes stay local)"
    echo "  - To update from remote: yadm pull"
    echo "  - To enable push: yadm remote set-url --push origin https://github.com/alexfazio/dotfiles.git"
fi

if [[ -f "$ARCHIVE" ]]; then
    echo ""
    echo "Secrets:"
    echo "  - Run 'yadm decrypt' to decrypt (requires password)"
fi

echo ""
